<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Link Budget Calculator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Hide number input arrows for cleaner table */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const FileSpreadsheet = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>
        );
        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        );
        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        );
        const Copy = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        );
        const Download = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        );

        // --- Math Logic (Ported from radarRange.py) ---
        const calculateRowMetrics = (row) => {
            const c = 299792458;
            
            // 1. Basic Conversions
            const freq_hz = row.freq_ghz * 1e9;
            const wavelength = c / freq_hz;
            const pt_watts = row.pt_watts;
            const range_meters = row.range_km * 1000;
            const rcs_m2 = row.rcs_m2;

            // Power to dBm
            const pt_dbm = 10 * Math.log10(pt_watts * 1000);
            
            // RCS to dBsm
            const rcs_dbsm = rcs_m2 > 0 ? 10 * Math.log10(rcs_m2) : -99;

            // 2. Path Loss
            // Formula: ((4pi)^3 * R^4) / lambda^2
            const numerator = Math.pow(4 * Math.PI, 3) * Math.pow(range_meters, 4);
            const denominator = Math.pow(wavelength, 2);
            const path_loss_linear = numerator / denominator;
            const radar_path_loss_db = 10 * Math.log10(path_loss_linear);

            // One-way FSPL reference
            const fspl_one_way_db = 20 * Math.log10((4 * Math.PI * range_meters) / wavelength);

            // 3. Received Power (Pr)
            // Pr = Pt + Gt + Gr + RCS - Loss - PathLoss
            const pr_dbm = (pt_dbm + row.gt_dbi + row.gr_dbi + rcs_dbsm) - row.loss_sys_db - radar_path_loss_db;

            return {
                wavelength,
                pt_dbm,
                rcs_dbsm,
                radar_path_loss_db,
                fspl_one_way_db,
                pr_dbm
            };
        };

        // --- Components ---

        function LinkBudgetApp() {
            // Initial State with one example row
            const [rows, setRows] = useState([
                {
                    id: 1,
                    name: "Scenario A",
                    freq_ghz: 3.0,
                    pt_watts: 100,
                    gt_dbi: 30,
                    gr_dbi: 30,
                    range_km: 5,
                    rcs_m2: 1.0,
                    loss_sys_db: 5.0
                },
                {
                    id: 2,
                    name: "Scenario B (Long Range)",
                    freq_ghz: 3.0,
                    pt_watts: 5000,
                    gt_dbi: 36,
                    gr_dbi: 36,
                    range_km: 100,
                    rcs_m2: 5.0,
                    loss_sys_db: 5.0
                }
            ]);

            const [selectedRowId, setSelectedRowId] = useState(1);

            // Update a specific field in a row
            const updateRow = (id, field, value) => {
                setRows(prev => prev.map(r => {
                    if (r.id !== id) return r;
                    let val = value;
                    // Numerical fields check
                    if (field !== 'name') {
                        val = parseFloat(value);
                        if (isNaN(val)) val = 0;
                    }
                    return { ...r, [field]: val };
                }));
            };

            const addRow = () => {
                const newId = Math.max(...rows.map(r => r.id), 0) + 1;
                setRows([...rows, {
                    id: newId,
                    name: "New Scenario",
                    freq_ghz: 3.0,
                    pt_watts: 100,
                    gt_dbi: 30,
                    gr_dbi: 30,
                    range_km: 10,
                    rcs_m2: 1.0,
                    loss_sys_db: 5.0
                }]);
                setSelectedRowId(newId);
            };

            const duplicateRow = (id) => {
                const rowToCopy = rows.find(r => r.id === id);
                const newId = Math.max(...rows.map(r => r.id), 0) + 1;
                setRows([...rows, { ...rowToCopy, id: newId, name: rowToCopy.name + " (Copy)" }]);
                setSelectedRowId(newId);
            };

            const deleteRow = (id) => {
                if (rows.length <= 1) return; // Prevent deleting last row
                setRows(prev => prev.filter(r => r.id !== id));
                if (selectedRowId === id) {
                    setSelectedRowId(rows[0].id);
                }
            };

            const exportCSV = () => {
                const header = "Name,Freq (GHz),Pt (W),Gt (dBi),Gr (dBi),Range (km),RCS (m2),Loss (dB),Path Loss (dB),Pr (dBm)\n";
                const csvContent = rows.map(r => {
                    const m = calculateRowMetrics(r);
                    return `${r.name},${r.freq_ghz},${r.pt_watts},${r.gt_dbi},${r.gr_dbi},${r.range_km},${r.rcs_m2},${r.loss_sys_db},${m.radar_path_loss_db.toFixed(2)},${m.pr_dbm.toFixed(2)}`;
                }).join("\n");

                const blob = new Blob([header + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "radar_link_budget.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            // Calculate metrics for the currently selected row for the details panel
            const selectedRow = rows.find(r => r.id === selectedRowId) || rows[0];
            const details = calculateRowMetrics(selectedRow);

            return (
                <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-900">
                    
                    {/* Header */}
                    <div className="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 shadow-md z-20">
                        <div className="flex items-center gap-3">
                            <FileSpreadsheet className="text-indigo-400" size={28} />
                            <div>
                                <h1 className="text-xl font-bold">Radar Link Budget Tool</h1>
                                <p className="text-xs text-slate-400">Interactive multi-scenario calculator</p>
                            </div>
                        </div>
                        <button onClick={exportCSV} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-sm font-medium transition-colors">
                            <Download size={16} />
                            Export CSV
                        </button>
                    </div>

                    <div className="flex flex-1 overflow-hidden">
                        
                        {/* Main Spreadsheet Area */}
                        <div className="flex-1 flex flex-col min-w-0 bg-white">
                            <div className="overflow-auto flex-1">
                                <table className="w-full text-left border-collapse min-w-[1000px]">
                                    <thead className="bg-slate-100 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-r border-slate-200 w-12 text-center">#</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-r border-slate-200 w-48">Scenario Name</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 bg-indigo-50/50">Freq (GHz)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 bg-indigo-50/50">Power (W)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 bg-indigo-50/50">Tx Gain (dBi)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 bg-indigo-50/50">Rx Gain (dBi)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 bg-orange-50/50">Range (km)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 bg-orange-50/50">RCS (mÂ²)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-r border-slate-200 w-24 bg-slate-50">Loss (dB)</th>
                                            
                                            {/* Outputs */}
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-32 bg-slate-50 text-right">Path Loss (dB)</th>
                                            <th className="p-3 text-xs font-bold text-indigo-600 uppercase border-b border-slate-200 w-32 bg-slate-50 text-right">Pr (dBm)</th>
                                            <th className="p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 w-24 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {rows.map((row, idx) => {
                                            const m = calculateRowMetrics(row);
                                            const isSelected = row.id === selectedRowId;
                                            return (
                                                <tr 
                                                    key={row.id} 
                                                    onClick={() => setSelectedRowId(row.id)}
                                                    className={`group transition-colors ${isSelected ? 'bg-indigo-50/40' : 'hover:bg-slate-50'}`}
                                                >
                                                    <td className="p-2 text-xs text-center text-slate-400 border-r border-slate-100">{idx + 1}</td>
                                                    <td className="p-2 border-r border-slate-100">
                                                        <input 
                                                            type="text" 
                                                            value={row.name} 
                                                            onChange={(e) => updateRow(row.id, 'name', e.target.value)}
                                                            className="w-full bg-transparent outline-none text-sm font-medium text-slate-700 placeholder-slate-300"
                                                            placeholder="Scenario Name"
                                                        />
                                                    </td>
                                                    <td className="p-2"><input type="number" value={row.freq_ghz} onChange={(e) => updateRow(row.id, 'freq_ghz', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right" /></td>
                                                    <td className="p-2"><input type="number" value={row.pt_watts} onChange={(e) => updateRow(row.id, 'pt_watts', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right" /></td>
                                                    <td className="p-2"><input type="number" value={row.gt_dbi} onChange={(e) => updateRow(row.id, 'gt_dbi', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right" /></td>
                                                    <td className="p-2"><input type="number" value={row.gr_dbi} onChange={(e) => updateRow(row.id, 'gr_dbi', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right" /></td>
                                                    <td className="p-2"><input type="number" value={row.range_km} onChange={(e) => updateRow(row.id, 'range_km', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right font-medium" /></td>
                                                    <td className="p-2"><input type="number" value={row.rcs_m2} onChange={(e) => updateRow(row.id, 'rcs_m2', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right font-medium" /></td>
                                                    <td className="p-2 border-r border-slate-100"><input type="number" value={row.loss_sys_db} onChange={(e) => updateRow(row.id, 'loss_sys_db', e.target.value)} className="w-full bg-transparent outline-none text-sm text-slate-600 text-right" /></td>
                                                    
                                                    <td className="p-3 text-sm text-right text-slate-500 font-mono bg-slate-50/30">
                                                        {m.radar_path_loss_db.toFixed(1)}
                                                    </td>
                                                    <td className="p-3 text-sm text-right font-bold text-indigo-700 font-mono bg-indigo-50/20 border-r border-slate-100">
                                                        {m.pr_dbm.toFixed(2)}
                                                    </td>
                                                    
                                                    <td className="p-2 text-center flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={(e) => { e.stopPropagation(); duplicateRow(row.id); }} title="Duplicate" className="p-1 text-slate-400 hover:text-blue-500"><Copy size={14} /></button>
                                                        <button onClick={(e) => { e.stopPropagation(); deleteRow(row.id); }} title="Delete" className="p-1 text-slate-400 hover:text-red-500"><Trash2 size={14} /></button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* Footer Toolbar */}
                            <div className="p-3 border-t border-slate-200 bg-slate-50 flex gap-3">
                                <button onClick={addRow} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 hover:text-indigo-600 transition-colors">
                                    <Plus size={16} />
                                    Add Scenario
                                </button>
                                <div className="ml-auto text-xs text-slate-400 flex items-center">
                                    *Click a row to view detailed breakdown
                                </div>
                            </div>
                        </div>

                        {/* Right Sidebar: Detailed Link Budget Card */}
                        <div className="w-80 bg-slate-100 border-l border-slate-200 flex flex-col shadow-xl z-10 shrink-0">
                            <div className="p-4 bg-white border-b border-slate-200">
                                <h2 className="text-sm font-bold text-slate-800 uppercase tracking-wide">Budget Breakdown</h2>
                                <p className="text-xs text-slate-500 truncate">{selectedRow.name}</p>
                            </div>
                            
                            <div className="p-4 space-y-6 overflow-y-auto flex-1">
                                {/* Physics Section */}
                                <div className="bg-white p-3 rounded border border-slate-200 shadow-sm">
                                    <h3 className="text-[10px] font-bold text-slate-400 uppercase mb-2">Physics</h3>
                                    <div className="space-y-1 text-sm">
                                        <div className="flex justify-between"><span>Frequency:</span> <span className="font-mono">{selectedRow.freq_ghz.toFixed(2)} GHz</span></div>
                                        <div className="flex justify-between"><span>Wavelength:</span> <span className="font-mono">{details.wavelength.toFixed(4)} m</span></div>
                                        <div className="flex justify-between"><span>Range:</span> <span className="font-mono">{(selectedRow.range_km).toFixed(2)} km</span></div>
                                    </div>
                                </div>

                                {/* Waterfall Calculation */}
                                <div className="bg-white p-3 rounded border border-slate-200 shadow-sm space-y-3">
                                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Link Budget</h3>
                                    
                                    <div className="space-y-2 text-sm font-mono">
                                        <div className="flex justify-between text-slate-600">
                                            <span>Tx Power</span>
                                            <span>{details.pt_dbm.toFixed(2)} dBm</span>
                                        </div>
                                        <div className="flex justify-between text-green-600">
                                            <span>+ Tx Gain</span>
                                            <span>{selectedRow.gt_dbi.toFixed(2)} dBi</span>
                                        </div>
                                        <div className="flex justify-between text-green-600">
                                            <span>+ Rx Gain</span>
                                            <span>{selectedRow.gr_dbi.toFixed(2)} dBi</span>
                                        </div>
                                        <div className="flex justify-between text-green-600">
                                            <span>+ RCS</span>
                                            <span>{details.rcs_dbsm.toFixed(2)} dBsm</span>
                                        </div>
                                        <div className="border-t border-slate-100 my-1"></div>
                                        <div className="flex justify-between text-red-500">
                                            <span>- Sys Loss</span>
                                            <span>{selectedRow.loss_sys_db.toFixed(2)} dB</span>
                                        </div>
                                        <div className="flex justify-between text-red-500">
                                            <span>- Path Loss</span>
                                            <span>{details.radar_path_loss_db.toFixed(2)} dB</span>
                                        </div>
                                        
                                        <div className="border-t-2 border-slate-200 my-2"></div>
                                        
                                        <div className="flex justify-between font-bold text-lg text-indigo-700 items-center">
                                            <span className="text-xs font-sans font-normal text-slate-500 uppercase">Received (Pr)</span>
                                            <span>{details.pr_dbm.toFixed(2)} dBm</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Reference Section */}
                                <div className="p-3 rounded border border-dashed border-slate-300 bg-slate-50/50 text-xs text-slate-500">
                                    <p className="mb-1 font-semibold">Reference Info:</p>
                                    <p>One-Way Free Space Loss (FSPL) would be: <span className="font-mono text-slate-700">{details.fspl_one_way_db.toFixed(2)} dB</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LinkBudgetApp />);
    </script>
</body>
</html>